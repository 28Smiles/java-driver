<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="High performance Java client for Apache Cassandra">
    <meta name="author" content="DataStax">

    <title>Java Driver for Apache Cassandra - Query idempotence</title>

    <link rel="icon" href="../../../favicon.ico">
    <link rel="apple-touch-icon" href="../../../favicon.png">
    <link href="../../../css/style.css" rel="stylesheet">
    <link href="../../../css/pygments.css" rel="stylesheet">
    <link href="../../../css/hotkeys.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body ng-app="docs">
    <div class="navbar">
      <div class="container-fluid">
        <div class="row row-offcanvas row-offcanvas-left">
          <div class="col-sm-3 text-center">
            <a class="ds-home" href="../../"><img alt="Brand" src="../../../img/logo.png"></a>
            <ul class="list-inline ds-sites" role="nav">
              <li><a href="https://academy.datastax.com/" class="navbar-link">DataStax Academy</a></li>
              <li><a href="http://www.datastax.com/dev/blog" class="navbar-link">Tech Blog</a></li>
              <li><a href="http://www.datastax.com/what-we-offer/products-services/support" class="navbar-link">Support</a></li>
            </ul>
          </div>
          <div class="col-md-5">
            <p class="lead pubtitle">Java Driver for Apache Cassandra</p>
            
            <div class="text-info">
              <span class="text-warning">Attention:</span> Viewing documentation for version
              <div class="btn-group">
                <button id="current-version" class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  3.0.1
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="current-version">
                
                  <li><a href="../../../manual/idempotence/">3.1.0</a></li>
                
                  <li><a href="../../../3.0.3/manual/idempotence/">3.0.3</a></li>
                
                  <li class="disabled"><a href="./">3.0.1</a></li>
                
                  <li><a href="../../../3.0.0/">3.0.0</a></li>
                
                  <li><a href="../../../2.1.10.1/manual/idempotence/">2.1.10.1</a></li>
                
                  <li><a href="../../../2.1.10/manual/idempotence/">2.1.10</a></li>
                
                  <li><a href="../../../2.1.9/">2.1.9</a></li>
                
                  <li><a href="../../../2.1.8/">2.1.8</a></li>
                
                  <li><a href="../../../2.1.7/">2.1.7</a></li>
                
                  <li><a href="../../../2.0.12.1/">2.0.12.1</a></li>
                
                  <li><a href="../../../2.0.12/">2.0.12</a></li>
                
                  <li><a href="../../../2.0.11/">2.0.11</a></li>
                
                </ul>
              </div>
            </div>
            
          </div>
          <div class="col-md-4">
            <form id="search" class="form-search dropdown visible-lg-inline-block" ng-controller="search" ng-class="{open: hasResults}" role="search" ng-submit="submit()" data-spy="affix" data-offset-top="130">
              <div class="form-group has-feedback">
                <input type="search" class="form-control input-sm mousetrap" placeholder="Search..." ng-model="q" ng-change="search('3.0.1')" ng-disabled="!searchReady" disabled data-hotkey="{down: moveDown, up: moveUp, esc: reset}" data-search>
              </div>
              <ul class="dropdown-menu search-results" role="menu">
                <li ng-repeat="result in results" ng-class="{'bg-warning': $index == current}"><a ng-href="{{basePath}}{{result.path}}"><span ng-bind-html="summary(result)"></span></a></li>
              </ul>
            </form>
            <a href="http://www.datastax.com/download" class="btn btn-primary btn-sm">Download</a>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid" id="content">
      <div class="row">
        <div class="col-md-3">
          <div id="navigation" class="side-nav" role="tablist" aria-multiselectable="true">
            <h3><a href="../../">Contents</a></h3>
            <ul class="nav nav-pills nav-stacked">
  
  
  <li>
    <a href="../../changelog/">
      Changelog <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../../faq/">
      Frequently Asked Questions <small>page</small>
      
    </a>
    
  </li>
  
  
  <li class="active">
    <a href="../">
      Manual <small>page</small>
      
      
      <span class="glyphicon glyphicon-minus-sign pull-right" aria-hidden="true"></span>
      
      
    </a>
    <ul class="nav nav-pills nav-stacked">
  
  
  <li>
    <a href="../address_resolution/">
      Address resolution <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../async/">
      Asynchronous programming <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../auth/">
      Authentication <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../compression/">
      Compression <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../pooling/">
      Connection pooling <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../control_connection/">
      Control connection <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../custom_codecs/">
      Custom Codecs <small>page</small>
      
      
      <span class="glyphicon glyphicon-plus-sign pull-right" aria-hidden="true"></span>
      
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../custom_payloads/">
      Custom Payloads <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../load_balancing/">
      Load balancing <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../logging/">
      Logging <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../metadata/">
      Metadata <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../metrics/">
      Metrics <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../native_protocol/">
      Native protocol <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../object_mapper/">
      Object Mapper <small>page</small>
      
      
      <span class="glyphicon glyphicon-plus-sign pull-right" aria-hidden="true"></span>
      
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../paging/">
      Paging <small>page</small>
      
    </a>
    
  </li>
  
  
  <li class="active">
    <a href="./" class="current">
      Query idempotence <small>page</small>
      
    </a>
    <ul class="nav nav-pills nav-stacked">
  
</ul>

  </li>
  
  
  <li>
    <a href="../query_timestamps/">
      Query timestamps <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../reconnection/">
      Reconnection <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../retries/">
      Retries <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../ssl/">
      SSL <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../socket_options/">
      Socket options <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../speculative_execution/">
      Speculative query execution <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../statements/">
      Statements <small>page</small>
      
      
      <span class="glyphicon glyphicon-plus-sign pull-right" aria-hidden="true"></span>
      
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../tuples/">
      Tuples <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../udts/">
      User-defined types <small>page</small>
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../shaded_jar/">
      Using the shaded JAR <small>page</small>
      
    </a>
    
  </li>
  
</ul>

  </li>
  
  
  <li>
    <a href="../../upgrade_guide/">
      Upgrade guide <small>page</small>
      
    </a>
    
  </li>
  
</ul>

          </div>
        </div>
        <div class="col-md-9 content">
          <div class="crumbs-wrapper">
            <nav id="crumbs" data-spy="affix" data-offset-top="130">
              <ol class="breadcrumb">
                
                
                
                <li><a href="../../">Home</a></li>
                
                
                
                
                
                <li><a href="../">Manual</a></li>
                
                
                
                
                
                <li class="active">Query idempotence</li>
                
                
                
              </ol>
            </nav>
          </div>
          

<h2 id="query-idempotence" class="target">Query idempotence<a class="anchor" href="#query-idempotence" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>

<p>A query is <em>idempotent</em> if it can be applied multiple times without changing the result of the initial application. For
example:</p>

<ul>
<li>
<code>update my_table set list_col = [1] where pk = 1</code> is idempotent: no matter how many times it gets executed, <code>list_col</code>
will always end up with the value <code>[1]</code>;</li>
<li>
<code>update my_table set list_col = [1] + list_col where pk = 1</code> is not idempotent: if <code>list_col</code> was initially empty,
it will contain <code>[1]</code> after the first execution, <code>[1, 1]</code> after the second, etc.</li>
</ul>

<p>Idempotence matters for <a href="../retries/">retries</a> and <a href="../speculative_execution/">speculative query executions</a>. The
corresponding policies inspect the <a href="http://docs.datastax.com/en/drivers/java/3.0/com/datastax/driver/core/Statement.html#isIdempotent--">Statement#isIdempotent()</a> flag.</p>

<p>In most cases, you must set that flag manually. The driver does not parse query strings, so it can’t infer it
automatically (except for statements coming from the query builder, see below).</p>

<p>Statements start out as non-idempotent by default. You can override the flag on each statement:</p>
<pre class="highlight"><code><span class="n">Statement</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleStatement</span><span class="o">(</span><span class="s">"SELECT * FROM users WHERE id = 1"</span><span class="o">);</span>
<span class="n">s</span><span class="o">.</span><span class="na">setIdempotent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre>
<p>The default is also configurable: if you want all statements to start out as idempotent, do this:</p>
<pre class="highlight"><code><span class="c1">// Make all statements idempotent by default:</span>
<span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getQueryOptions</span><span class="o">().</span><span class="na">setDefaultIdempotence</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre>
<p>Any statement on which you didn’t call <code>setIdempotent</code> gets this default value.</p>

<p>Bound statements inherit the flag from the prepared statement they were created from:</p>
<pre class="highlight"><code><span class="n">PreparedStatement</span> <span class="n">pst</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="s">"SELECT * FROM users WHERE id = ?"</span><span class="o">);</span>
<span class="c1">// This cast is for backward-compatibility reasons. On 3.0+, you can do pst.setIdempotent(true) directly</span>
<span class="o">((</span><span class="n">IdempotenceAwarePreparedStatement</span><span class="o">)</span> <span class="n">pst</span><span class="o">).</span><span class="na">setIdempotent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

<span class="n">BoundStatement</span> <span class="n">bst</span> <span class="o">=</span> <span class="n">pst</span><span class="o">.</span><span class="na">bind</span><span class="o">();</span>
<span class="k">assert</span> <span class="n">bst</span><span class="o">.</span><span class="na">isIdempotent</span><span class="o">();</span>
</code></pre>
<h3 id="idempotence-in-the-query-builder" class="target">Idempotence in the query builder<a class="anchor" href="#idempotence-in-the-query-builder" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The <a href="http://docs.datastax.com/en/drivers/java/3.0/com/datastax/driver/core/querybuilder/QueryBuilder.html">QueryBuilder</a> DSL tries to infer the <code>isIdempotent</code> flag on the statements it generates. The following statements
will be marked <strong>non-idempotent</strong>:</p>

<ul>
<li>
<p>counter updates:</p>
<pre class="highlight"><code><span class="n">update</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">incr</span><span class="o">(</span><span class="s">"c"</span><span class="o">)).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</code></pre>
</li>
<li>
<p>prepend, append or deletion operations on lists:</p>
<pre class="highlight"><code><span class="n">update</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">append</span><span class="o">(</span><span class="s">"l"</span><span class="o">,</span> <span class="mi">1</span><span class="o">)).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
<span class="n">delete</span><span class="o">().</span><span class="na">listElt</span><span class="o">(</span><span class="s">"l"</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">from</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</code></pre>
</li>
<li>
<p>queries that insert the result of a function call or a “raw” string in a column (or as an element in a collection
column):</p>
<pre class="highlight"><code><span class="n">update</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="s">"v"</span><span class="o">,</span> <span class="n">now</span><span class="o">())).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
<span class="n">update</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="s">"v"</span><span class="o">,</span> <span class="n">fcall</span><span class="o">(</span><span class="s">"myCustomFunc"</span><span class="o">))).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
<span class="n">update</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="s">"v"</span><span class="o">,</span> <span class="n">raw</span><span class="o">(</span><span class="s">"myCustomFunc()"</span><span class="o">))).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</code></pre>
<p>This is a conservative approach, since the driver can’t guess whether a function is idempotent, or what a raw string
contains. It might yield false negatives, that you’ll have to fix manually.</p>
</li>
<li>
<p>lightweight transactions (see the next section for a detailed explanation):</p>
<pre class="highlight"><code><span class="n">insertInto</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"v"</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="na">ifNotExists</span><span class="o">();</span>
</code></pre>
</li>
</ul>

<p>If these rules produce a false negative, you can manually override the flag on the built statement:</p>
<pre class="highlight"><code><span class="n">BuiltStatement</span> <span class="n">s</span> <span class="o">=</span> <span class="n">update</span><span class="o">(</span><span class="s">"mytable"</span><span class="o">).</span><span class="na">with</span><span class="o">(</span><span class="n">set</span><span class="o">(</span><span class="s">"v"</span><span class="o">,</span> <span class="n">fcall</span><span class="o">(</span><span class="s">"anIdempotentFunc"</span><span class="o">))).</span><span class="na">where</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="s">"k"</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>

<span class="c1">// False negative because the driver can't guess that anIdempotentFunc() is safe</span>
<span class="k">assert</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="na">isIdempotent</span><span class="o">();</span>

<span class="c1">// Fix it</span>
<span class="n">s</span><span class="o">.</span><span class="na">setIdempotent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre>
<h3 id="idempotence-and-lightweight-transactions" class="target">Idempotence and lightweight transactions<a class="anchor" href="#idempotence-and-lightweight-transactions" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>As explained in the previous section, the query builder considers lightweight transactions as non-idempotent. This might
sound counter-intuitive, as these queries can sometimes be safe to execute multiple times. For example, consider the
following query:</p>
<pre><code>UPDATE mytable SET v = 4 WHERE k = 1 IF v = 1
</code></pre>
<p>If we execute it twice, the <code>IF</code> condition will fail the second time, so the second execution will do nothing and <code>v</code>
will still have the value 4.</p>

<p>However, the problem appears when we consider multiple clients executing the query with retries:</p>

<ol>
<li>
<code>v</code> has the value 1;</li>
<li>client 1 executes the query above, performing a a CAS (compare and set) from 1 to 4;</li>
<li>client 1’s connection drops, but the query completes successfully. <code>v</code> now has the value 4;</li>
<li>client 2 executes a CAS from 4 to 2;</li>
<li>client 2’s transaction succeeds. <code>v</code> now has the value 2;</li>
<li>since client 1 lost its connection, it considers the query as failed, and transparently retries the CAS from 1 to 4.
But since the column now has value 2, it receives a “not applied” response.</li>
</ol>

<p>One important aspect of lightweight transactions is <a href="https://en.wikipedia.org/wiki/Linearizability#Definition_of_linearizability">linearizability</a>: given a set of concurrent operations on a column
from different clients, there must be a way to reorder them to yield a sequential history that is correct. From our
clients’ point of view, there were two operations:</p>

<ul>
<li>client 1 executed a CAS from 1 to 4, that was not applied;</li>
<li>client 2 executed a CAS from 4 to 2, that was applied.</li>
</ul>

<p>But overall the column changed from 1 to 2. There is no ordering of the two operations that can explain that change. We
broke linearizability by doing a transparent retry at step 6.</p>

<p>To avoid this, the driver considers lightweight transactions as non-idempotent, and provides a
<a href="../retries/">retry policy</a> that doesn’t retry non-idempotent statements. If linearizability is important for you, you
should use that policy, and ensure that lightweight transactions are appropriately flagged.</p>


        </div>
      </div>
    </div>

    
    <footer class="container text-muted">
      <ul class="list-inline">
      
        
        <li>
          <a href="https://github.com/datastax/java-driver/">Code</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="http://datastax.github.io/java-driver/">Docs</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://datastax-oss.atlassian.net/browse/JAVA/">Issues</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://groups.google.com/a/lists.datastax.com/forum/#!forum/java-driver-user">Mailing List</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="irc://irc.freenode.net/datastax-drivers">IRC Channel</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://github.com/datastax/java-driver/releases">Releases</a>
        </li>
      
      </ul>
    </footer>
    

    <script src="../../../js/jquery.js"></script>
    <script src="../../../js/bootstrap.js"></script>
    <script src="../../../js/angular.js"></script>
    <script src="../../../js/mousetrap.js"></script>
    <script src="../../../js/hotkeys.js"></script>
    <script src="../../../js/ZeroClipboard.js"></script>
    <script src="../../../js/lunr.js"></script>
    <script src="../../../js/app.js"></script>
  </body>
</html>
