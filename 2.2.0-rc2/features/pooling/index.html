<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="High performance Java client for Apache Cassandra">
    <meta name="author" content="DataStax">

    <title>Java Driver for Apache Cassandra - Connection pooling</title>

    <link rel="icon" href="../../../favicon.ico">
    <link rel="apple-touch-icon" href="../../../favicon.png">
    <link href="../../../css/style.css" rel="stylesheet">
    <link href="../../../css/pygments.css" rel="stylesheet">
    <link href="../../../css/hotkeys.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body ng-app="docs" data-spy="scroll" data-target=".side-nav">
    <header class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">Java Driver for Apache Cassandra</a>
        </div>
        <div class="collapse navbar-collapse" ng-controller="search">
          <ul class="nav navbar-nav">
            
            
            
            <li class="active">
              <a href="../">Features</a>
            </li>
            
            
            <li>
              <a href="../../changelog/">Changelog</a>
            </li>
            
            
            <li>
              <a href="../../upgrade_guide/">Upgrading</a>
            </li>
            
            
            <li>
              <a href="../../faq/">FAQ</a>
            </li>
            
          </ul>
          <form class="navbar-form form-search navbar-right dropdown visible-lg-block" ng-class="{open: hasResults}" role="search" ng-submit="submit()">
            <div class="form-group has-feedback">
              <input type="search" class="form-control input-sm mousetrap" placeholder="Search..." ng-model="q" ng-change="search('2.2.0-rc2')" ng-disabled="!searchReady" disabled data-hotkey="{down: moveDown, up: moveUp, esc: reset}" data-search>
            </div>
            <ul class="dropdown-menu" role="menu">
              <li ng-repeat="result in results" ng-class="{'bg-warning': $index == current}"><a ng-href="{{basePath}}{{result.path}}"><span ng-bind-html="summary(result)"></span></a></li>
            </ul>
          </form>
        </div>
      </div>
    </header>

    <div class="container" id="content">
      <div class="row">
        <div class="col-md-9 content">
          <nav class="crumbs">
            <ol class="breadcrumb">
              
              <li>
                <div class="dropdown">
                  <button id="current-version" class="btn btn-default btn-sm" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    2.2.0-rc2
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="current-version">
                  
                    <li><a href="../../../features/pooling/">2.2.0-rc3</a></li>
                  
                    <li class="disabled"><a href="./">2.2.0-rc2</a></li>
                  
                    <li><a href="../../../2.2.0-rc1/features/pooling/">2.2.0-rc1</a></li>
                  
                    <li><a href="../../../2.1.7/features/pooling/">2.1.7</a></li>
                  
                    <li><a href="../../../2.1.6/features/pooling/">2.1.6</a></li>
                  
                    <li><a href="../../../2.1.5/">2.1.5</a></li>
                  
                    <li><a href="../../../2.0.10.1/features/pooling/">2.0.10.1</a></li>
                  
                    <li><a href="../../../2.0.10/features/pooling/">2.0.10</a></li>
                  
                  </ul>
                </div>
              </li>
              
              
              
              
              <li><a href="../../">Home</a></li>
              
              
              
              
              
              <li><a href="../">Features</a></li>
              
              
              
              
              
              <li class="active">Connection pooling</li>
              
              
              
            </ol>
          </nav>
          

<h2 id="connection-pooling">Connection pooling<a class="anchor" href="#connection-pooling" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>

<h3 id="basics">Basics<a class="anchor" href="#basics" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The driver communicates with Cassandra over TCP, using the Cassandra
binary protocol. This protocol is asynchronous, which allows each TCP
connection to handle multiple simultaneous requests:</p>

<ul>
<li>when a query gets executed, a <em>stream id</em> gets assigned to it. It is a
unique identifier on the current connection;</li>
<li>the driver writes a request containing the stream id and the query on
the connection, and then proceeds without waiting for the response (if
you’re using the asynchronous API, this is when the driver will send you
back a <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/ResultSetFuture.html">ResultSetFuture</a>).
Once the request has been written to the
connection, we say that it is <em>in flight</em>;</li>
<li>at some point, Cassandra will send back a response on the connection.
This response also contains the stream id, which allows the driver to
trigger a callback that will complete the corresponding query (this is
the point where your <code>ResultSetFuture</code> will get completed).</li>
</ul>

<p>To increase the number of concurrent requests, we use a pool of
connections to each host.  <strong>For each <code>Session</code> object, there is one
connection pool per connected host</strong>.</p>

<p>The number of connections per pool is configurable (this will be
described in the next section).  The number of stream ids depends on the
<a href="../native_protocol/">native protocol version</a>:</p>

<ul>
<li>protocol v2 or below: 128 stream ids per connection.</li>
<li>protocol v3 or above: up to 32768 stream ids per connection.</li>
</ul>
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu4AAABiCAIAAACAksEXAAARC0lEQVR42u2d%0AeVBV5RvHUxAEUpEkNMlKhQZMzCQHS9OMLEakzJq2sWUclTZbcEKnzBkVybIk%0Axq1soiwpd0KjhRELZShIoEDBGlTcUApiTwjq94zv/M7cuZdzvOB27z2fzx/M%0Afd9z7nl5n+18z3qv+A8AAADAabkCEwAAAABSBgAAAOCySpl/AQAAAJwEpAwA%0AAAAgZQAAAACQMgAAAABIGQAAAEDKAAAAACBlAAAAAJAyAAAAAEgZAAAAQMoA%0AAAAAIGUAAAAAkDIAAACAlEHKAAAAAFIGAAAAACkDAAAAgJQBAAAApAwAAAAA%0AUgYAAAAAKQMAAACAlAEAAACkDAAAAABSBgAAAAApAwAAAEgZpAwAAAAgZQAA%0AAACQMgAAAABIGQegpqYmLS3t5ZdfLi4uxhr4CEsC3r/YIx48eDAlJWXOnDnT%0Apk1buXLl4cOHrb74999/Z2RkPPvss0899VRqaqpsp8Ptb9iwITMzU30uLy9P%0ATk5+5plnYmJiFi9enJub297ebueImzZtWrJkyb59+7QeWTkxMbG5uZmwQco4%0AAREREd27d7/iLNnZ2RgEH2FJwPsXe8T77rvP3d19/PjxY8eOdXNzkxWWL1+u%0ALW1sbAwLC/P09Lz//vtvu+02WRoSEiLixmr7ra2tffv23bx5s2q+9957fn5+%0AU87i4+Mj31q4cKGdI8pS6VmzZo1qrl+/XppLly4lbJAyzkFSUlJ+fv71119P%0AccdHWBLw/qUZUfr/+usvbTVZoU+fPtpJlO3bt0vP3LlzVXPixInSLCgosNr+%0A7t27PTw86urqVLOhoUHbwqpVq+QrQ4YMsXNESylTWFjo5eUVExNjeVIHkDJO%0AwODBgy9lcY+Pjx8zZsy2bdvWrVsXHh4uhx3yGS/gIywJLuZ9e0bMysqSFXx8%0AfM6cOaN6MjMzpSciIqK+vl5JGZEd2lKNuLi4SZMmdbjNxMRE2cJDDz1k54ia%0AlKmurpZ/WDSQ3iUtQMqQ3v9apo3U9yuvvHLYsGHy2dfX1zZRAR9hSXB5KRMb%0AGysrTJ06VetpaWkZN26cdA4aNGj27Nk9e/bcuXOn7ReDg4OTk5Mte06fPv3d%0Ad98tXrzYz88vNDS0qKjIzhFVlK5cuTIqKsrLy6uwsJBQQcqQ3nYVdxH+p06d%0AkubVV18tzV27duEIfIQlwVRS5osvvujevXtISEhlZaVlf15ennafzS233FJV%0AVWX1xbKyMll06NAhy85Zs2apr/Tr1y8/P9/+EVWU3njjjfJ3+PDhSG0nkDJX%0AmA/HLO6rVq1SzVGjRkkzPT0dH+EjLAmu5H3jETMyMjw8PEQ6nDx50rI/JyfH%0A19d3woQJaWlpIoLV6ZmKigrLdZYvX37TTTdZbbC6ujo3N1cWiVLp1q1bfHy8%0AnSOqKH3llVd69+4tH2JjY9mHdiquLo+U+c9MyHxra2sbGhqam5tbWlra2toc%0ApLhrd8t3WNzxET7CkuDs3jcYcevWre7u7qJX1A0xlkyePFm+cuDAAfksS6dM%0AmSLNRYsWWa4jX5w/f77eoLt27ZKveHt7azcFG4+oRemWLVvUzjslJYV9qP1x%0AhZS5FG4QOV9ZWSmCXZwhnqC44yMXljJY0sxSxtG8rzdiVlaWp6dnUFBQU1OT%0A7Vf8/PzkK9qraDIyMqT5+OOPayvU1NSIKMnJydEb9NSpU+qJ659//tmeES2j%0ANC4uTj57eXnZPjNFfdaLK6TMpXCDpMTvv/9+/Phx8YTVK49yc3MlH6655hpZ%0AbfXq1fL5jz/+oLjjI+eVMljSzFLGobxvMKK6ZWrYsGEPW6C9OUadhomMjPzx%0Axx8LCwvVw9gbN27UtrxhwwZ/f3+r0wOywtq1a0tKSvLy8h588EH5SmBgoHbX%0Ai/GIllHa2tqqbjoWESZmZB9qHFdImUvnhr179xYVFYknRFeKqLS0hre3t9VF%0AQcuEobjjI6eTMljSzFLGobxvMKLtIqGxsVEtraqqmjFjhtJAgp+fX1JSkuWW%0AH3300SeffNJquLlz51pubfTo0ZZPMBmPaBWlJ06cCAgIkJ7Jkyfbvl2G+oyU%0AuTxuyMjIEE+IrqyoqKitrXX8+73xET7CkmAG7xvz66+/lpSUWL3n1+olv5bU%0A19fL+jk5OUePHiViHSeukDIXxg2ff/75N998k5eXJ6KywxOGFHd85DJSBkua%0AWco4nfe7gNVLfolYx48rh5YyR44cEckssyK9SRV8dLGxM92wJFLG5aVMY2Pj%0A6dOniVikTOfcUFxcnJCQ8MQTT0RHR8fGxiYmJmZnZ0u/uri4du1a0vtypYq6%0AsW7evHkxMTEvvPDCihUrLqzpnn/++dDQ0I0bN+Kjzvpo8+bNCf8nOTk5PT29%0A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%0AAABJRU5ErkJggg==%0A" alt="Text Diagram" class="img-rounded img-thumbnail center-block ditaa">
<h3 id="configuring-the-connection-pool">Configuring the connection pool<a class="anchor" href="#configuring-the-connection-pool" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>Connections pools are configured with a <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html">PoolingOptions</a> object, which 
is global to a <code>Cluster</code> instance. You can pass that object when
building the cluster:</p>
<pre class="highlight"><code><span class="n">PoolingOptions</span> <span class="n">poolingOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PoolingOptions</span><span class="o">();</span>
<span class="c1">// customize options...</span>

<span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withContactPoints</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withPoolingOptions</span><span class="o">(</span><span class="n">poolingOptions</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
<p>Most options can also be changed at runtime. If you don’t have a
reference to the <code>PoolingOptions</code> instance, here’s how you can get it:</p>
<pre class="highlight"><code><span class="n">PoolingOptions</span> <span class="n">poolingOptions</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getPoolingOptions</span><span class="o">();</span>
<span class="c1">// customize options...</span>
</code></pre>
<h4 id="pool-size">Pool size<a class="anchor" href="#pool-size" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>Connection pools have a variable size, which gets adjusted automatically
depending on the current load. There will always be at least a <em>core</em>
number of connections, and at most a <em>max</em> number. These values can be
configured independently by host <em>distance</em> (the distance is determined
by your <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/policies/LoadBalancingPolicy.html">LoadBalancingPolicy</a>, and will generally indicate whether a
host is in the same datacenter or not).</p>
<pre class="highlight"><code><span class="n">poolingOptions</span>
    <span class="o">.</span><span class="na">setCoreConnectionsPerHost</span><span class="o">(</span><span class="n">HostDistance</span><span class="o">.</span><span class="na">LOCAL</span><span class="o">,</span>  <span class="mi">4</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setMaxConnectionsPerHost</span><span class="o">(</span> <span class="n">HostDistance</span><span class="o">.</span><span class="na">LOCAL</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setCoreConnectionsPerHost</span><span class="o">(</span><span class="n">HostDistance</span><span class="o">.</span><span class="na">REMOTE</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setMaxConnectionsPerHost</span><span class="o">(</span> <span class="n">HostDistance</span><span class="o">.</span><span class="na">REMOTE</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</code></pre>
<p>For convenience, core and max can be set simultaneously:</p>
<pre class="highlight"><code><span class="n">poolingOptions</span>
    <span class="o">.</span><span class="na">setConnectionsPerHost</span><span class="o">(</span><span class="n">HostDistance</span><span class="o">.</span><span class="na">LOCAL</span><span class="o">,</span>  <span class="mi">4</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setConnectionsPerHost</span><span class="o">(</span><span class="n">HostDistance</span><span class="o">.</span><span class="na">REMOTE</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
</code></pre>
<p>The default settings are:</p>

<ul>
<li>protocol v2:

<ul>
<li>
<code>LOCAL</code> hosts: core = 2, max = 8</li>
<li>
<code>REMOTE</code> hosts: core = 1, max = 2</li>
</ul>
</li>
<li>protocol v3:

<ul>
<li>
<code>LOCAL</code> hosts: core = max = 1</li>
<li>
<code>REMOTE</code> hosts: core = max = 1</li>
</ul>
</li>
</ul>

<p><a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setNewConnectionThreshold(com.datastax.driver.core.HostDistance,%20int)">PoolingOptions.setNewConnectionThreshold</a> determines the threshold
that triggers the creation of a new connection when the pool is not at
its maximum capacity. In general, you shouldn’t need to change its
default value.</p>

<h4 id="dynamic-resizing">Dynamic resizing<a class="anchor" href="#dynamic-resizing" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>If core != max, the pool will resize automatically to adjust to the
current activity on the host.</p>

<p>When activity goes up and there are <em>n</em> connections with n &lt; max, the driver
will add a connection when the number of concurrent requests is more than
(n - 1) * 128 + <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setNewConnectionThreshold(com.datastax.driver.core.HostDistance,%20int)">PoolingOptions.setNewConnectionThreshold</a>
(in layman’s terms, when all but the last connection are full and the last
connection is above the threshold).</p>

<p>When activity goes down, the driver will “trash” connections if the maximum
number of requests in a 10 second time period can be satisfied by less than
the number of connections opened. Trashed connections are kept open but do
not accept new requests. After a given timeout (defined by
<a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setIdleTimeoutSeconds(int)">PoolingOptions.setIdleTimeoutSeconds</a>), trashed connections are closed
and removed. If during that idle period activity increases again, those
connections will be resurrected back into the active pool and reused. The
main intent of that is to not constantly recreate connections if activity
changes quickly over an interval.</p>

<h4 id="simultaneous-requests-per-connection">Simultaneous requests per connection<a class="anchor" href="#simultaneous-requests-per-connection" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p><a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setMaxRequestsPerConnection(com.datastax.driver.core.HostDistance,%20int)">PoolingOptions.setMaxRequestsPerConnection</a> allows you to
throttle the number of concurrent requests per connection.</p>

<p>With protocol v2, there is no reason to throttle. It is set to 128 (the
max) and you should not change it.</p>

<p>With protocol v3, it is set to 1024 for <code>LOCAL</code>  hosts, and 256 for
<code>REMOTE</code> hosts. These low defaults were chosen so that the default
configuration for protocol v2 and v3 allow the same total number of
simultaneous requests (to avoid bad surprises when clients migrate from
v2 to v3). You can raise this threshold, or even set it to the max:</p>
<pre class="highlight"><code><span class="n">poolingOptions</span>
    <span class="o">.</span><span class="na">setMaxRequestsPerConnection</span><span class="o">(</span><span class="n">HostDistance</span><span class="o">.</span><span class="na">LOCAL</span><span class="o">,</span> <span class="mi">32768</span><span class="o">)</span>
    <span class="o">.</span><span class="na">setMaxRequestsPerConnection</span><span class="o">(</span><span class="n">HostDistance</span><span class="o">.</span><span class="na">REMOTE</span><span class="o">,</span> <span class="mi">2000</span><span class="o">);</span>
</code></pre>
<p>Just keep in mind that high values will give clients more bandwidth and
therefore put more pressure on your cluster. This might require some
tuning, especially if you have many clients.</p>

<h4 id="heartbeat">Heartbeat<a class="anchor" href="#heartbeat" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>If connections stay idle for too long, they might be dropped by
intermediate network devices (routers, firewalls…). Normally, TCP
keepalive should take care of this; but tweaking low-level keepalive
settings might be impractical in some environments.</p>

<p>The driver provides application-side keepalive in the form of a
connection heartbeat: when a connection has been idle for a given amount
of time, the driver will simulate activity by writing a dummy request to
it.</p>

<p>This feature is enabled by default. The default heartbeat interval is 30
seconds, it can be customized with the following method:</p>
<pre class="highlight"><code><span class="n">poolingOptions</span><span class="o">.</span><span class="na">setHeartbeatIntervalSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
</code></pre>
<p>If it gets changed at runtime, only connections created after that will
use the new interval. Most users will want to do this at startup.</p>

<p>The heartbeat interval should be set higher than
<a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/SocketOptions.html#getReadTimeoutMillis()">SocketOptions.readTimeoutMillis</a>:
the read timeout is the maximum time that the driver waits for a regular
query to complete, therefore the connection should not be considered
idle before it has elapsed.</p>

<p>To disable heartbeat, set the interval to 0.</p>

<p>Implementation note: the dummy request sent by heartbeat is an
<a href="https://github.com/apache/cassandra/blob/trunk/doc/native_protocol_v3.spec#L278">OPTIONS</a>
message.</p>

<h4 id="acquisition-timeout">Acquisition timeout<a class="anchor" href="#acquisition-timeout" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>When the driver tries to send a request to a host, it will first try to
acquire a connection from this host’s pool. If the pool is busy (i.e.
all connections are already handling their maximum number of in flight
requests), the client thread will block for a while, until a connection
becomes available (note that this will block even if you’re using the
asynchronous API, like <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/Session.html#executeAsync(com.datastax.driver.core.Statement)">Session.executeAsync</a>).</p>

<p>The time that the driver blocks is controlled by
<a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setPoolTimeoutMillis(int)">PoolingOptions.setPoolTimeoutMillis</a>. If there is still no connection
available after this timeout, the driver will try the next host.</p>

<p>For some applications, blocking is not acceptable, and it is preferable
to fail fast if the request cannot be fulfilled. If that’s your case,
set the pool timeout to 0. If all hosts are busy, you will get a
<a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/exceptions/NoHostAvailableException.html">NoHostAvailableException</a> (if you look at the exception’s details, you
will see a <code>java.util.concurrent.TimeoutException</code> for each host).</p>

<h3 id="monitoring-and-tuning-the-pool">Monitoring and tuning the pool<a class="anchor" href="#monitoring-and-tuning-the-pool" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The easiest way to monitor pool usage is with <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/Session.html#getState()">Session.getState</a>. Here’s
a simple example that will print the number of open connections, active
requests, and maximum capacity for each host, every 5 seconds:</p>
<pre class="highlight"><code><span class="kd">final</span> <span class="n">LoadBalancingPolicy</span> <span class="n">loadBalancingPolicy</span> <span class="o">=</span>
    <span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getPolicies</span><span class="o">().</span><span class="na">getLoadBalancingPolicy</span><span class="o">();</span>
<span class="kd">final</span> <span class="n">PoolingOptions</span> <span class="n">poolingOptions</span> <span class="o">=</span>
<span class="n">cluster</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">().</span><span class="na">getPoolingOptions</span><span class="o">();</span>

<span class="n">ScheduledExecutorService</span> <span class="n">scheduled</span> <span class="o">=</span>
<span class="n">Executors</span><span class="o">.</span><span class="na">newScheduledThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">scheduled</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Session</span><span class="o">.</span><span class="na">State</span> <span class="n">state</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">getState</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Host</span> <span class="n">host</span> <span class="o">:</span> <span class="n">state</span><span class="o">.</span><span class="na">getConnectedHosts</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">HostDistance</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">loadBalancingPolicy</span><span class="o">.</span><span class="na">distance</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">connections</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">getOpenConnections</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">inFlightQueries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">getInFlightQueries</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%s connections=%d, current load=%d, max
load=%d%n"</span><span class="o">,</span>
                <span class="n">host</span><span class="o">,</span> <span class="n">connections</span><span class="o">,</span> <span class="n">inFlightQueries</span><span class="o">,</span>
                <span class="n">connections</span> <span class="o">*</span>
<span class="n">poolingOptions</span><span class="o">.</span><span class="na">getMaxRequestsPerConnection</span><span class="o">(</span><span class="n">distance</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">},</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</code></pre>
<p>In real life, you’ll probably want something more sophisticated, like
exposing a JMX MBean or sending the data to your favorite monitoring
tool.</p>

<p>If you find that the current load stays close or equal to the maximum
load at all time, it’s a sign that your connection pools are saturated
and you should raise the max connections per host, or max requests per
connection (protocol v3).</p>

<p>If you’re using protocol v2 and the load is often less than core * 128,
your pools are underused and you could get away with less core
connections.</p>

<h4 id="tuning-protocol-v3-for-very-high-throughputs">Tuning protocol v3 for very high throughputs<a class="anchor" href="#tuning-protocol-v3-for-very-high-throughputs" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h4>

<p>As mentioned above, the default pool size for protocol v3 is core = max
= 1. This means all requests to a given node will share a single
connection, and therefore a single Netty I/O thread.</p>

<p>There is a corner case where this I/O thread can max out its CPU core
and become a bottleneck in the driver; in our benchmarks, this happened
with a single-node cluster and a high throughput (approximately 80K
requests / second).</p>

<p>It’s unlikely that you’ll run into this issue: in most real-world
deployments, the driver connects to more than one node, so the load will
spread across more I/O threads. However if you suspect that you
experience the issue, here’s what to look out for:</p>

<ul>
<li>the driver throughput plateaus but the process does not appear to
max out any system resource (in particular, overall CPU usage is well
below 100%);</li>
<li>one of the driver’s I/O threads maxes out its CPU core. You can see
that with a profiler, or OS-level tools like <code>pidstat -tu</code> on Linux.
I/O threads are called <code>&lt;cluster_name&gt;-nio-worker-&lt;n&gt;</code>, unless you’re
injecting your own <code>EventLoopGroup</code> with <code>NettyOptions</code>.</li>
</ul>

<p>The solution is to add more connections per node. To ensure that
additional connections get created before you run into the bottleneck,
either:</p>

<ul>
<li>set core = max;</li>
<li>keep core = 1, but adjust <a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setMaxRequestsPerConnection(com.datastax.driver.core.HostDistance,%20int)">maxRequestsPerConnection</a> and
<a href="http://docs.datastax.com/en/drivers/java/2.2/com/datastax/driver/core/PoolingOptions.html#setNewConnectionThreshold(com.datastax.driver.core.HostDistance,%20int)">newConnectionThreshold</a> so that enough connections are added by
the time you reach the bottleneck.</li>
</ul>


        </div>
        <div class="col-md-3">
          <div id="navigation" class="panel-group side-nav" data-spy="affix" data-offset-top="60" data-offset-bottom="80" role="tablist" aria-multiselectable="true">
            <div id="table-of-contents-panel" class="panel panel-default">
              <div id="table-of-contents-heading" class="panel-heading" role="tab">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#table-of-contents" aria-expanded="true" aria-controls="table-of-contents">
                    Contents<i class="pull-right glyphicon glyphicon-chevron-up"></i>
                  </a>
                </h4>
              </div>
              <div id="table-of-contents" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="table-of-contents-heading">
                <div class="panel-body">
                  <ol class="nav nav-pills nav-stacked toc"><li>
<a href="#connection-pooling">Connection pooling
</a><ol class="nav nav-pills nav-stacked">
<li><a href="#basics">Basics
</a></li>
<li>
<a href="#configuring-the-connection-pool">Configuring the connection pool
</a><ol class="nav nav-pills nav-stacked">
<li><a href="#pool-size">Pool size
</a></li>
<li><a href="#dynamic-resizing">Dynamic resizing
</a></li>
<li><a href="#simultaneous-requests-per-connection">Simultaneous requests per connection
</a></li>
<li><a href="#heartbeat">Heartbeat
</a></li>
<li><a href="#acquisition-timeout">Acquisition timeout
</a></li>
</ol>
</li>
<li>
<a href="#monitoring-and-tuning-the-pool">Monitoring and tuning the pool
</a><ol class="nav nav-pills nav-stacked"><li><a href="#tuning-protocol-v3-for-very-high-throughputs">Tuning protocol v3 for very high throughputs
</a></li></ol>
</li>
</ol>
</li></ol>
                </div>
              </div>
            </div>

            
          </div>
        </div>
      </div>
    </div>

    
    <footer class="container text-muted">
      <ul class="list-inline">
      
        
        <li>
          <a href="https://github.com/datastax/java-driver/">Code</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="http://datastax.github.io/java-driver/">Docs</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://datastax-oss.atlassian.net/browse/JAVA/">Issues</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://groups.google.com/a/lists.datastax.com/forum/#!forum/java-driver-user">Mailing List</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="irc://irc.freenode.net/datastax-drivers">IRC Channel</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://github.com/datastax/java-driver/releases">Releases</a>
        </li>
      
      </ul>
    </footer>
    

    <script src="../../../js/jquery.js"></script>
    <script src="../../../js/bootstrap.js"></script>
    <script src="../../../js/angular.js"></script>
    <script src="../../../js/mousetrap.js"></script>
    <script src="../../../js/hotkeys.js"></script>
    <script src="../../../js/ZeroClipboard.js"></script>
    <script src="../../../js/lunr.js"></script>
    <script src="../../../js/app.js"></script>
  </body>
</html>
