<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="High performance Java client for Apache Cassandra">
    <meta name="author" content="DataStax">

    <title>Java Driver for Apache Cassandra - Frequently Asked Questions - OSGi</title>

    <link rel="icon" href="../../favicon.ico">
    <link rel="apple-touch-icon" href="../../favicon.png">
    <link href="../../css/style.css" rel="stylesheet">
    <link href="../../css/pygments.css" rel="stylesheet">
    <link href="../../css/hotkeys.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body ng-app="docs">
    <div class="navbar">
      <div class="container-fluid">
        <div class="row row-offcanvas row-offcanvas-left">
          <div class="col-sm-3 text-center">
            <a class="ds-home" href="../../"><img alt="Brand" src="../../img/logo.png"></a>
            <ul class="list-inline ds-sites" role="nav">
              <li><a href="https://academy.datastax.com/" class="navbar-link">DataStax Academy</a></li>
              <li><a href="http://www.datastax.com/dev/blog" class="navbar-link">Tech Blog</a></li>
              <li><a href="http://www.datastax.com/what-we-offer/products-services/support" class="navbar-link">Support</a></li>
            </ul>
          </div>
          <div class="col-md-5">
            <p class="lead pubtitle">Java Driver for Apache Cassandra</p>
            
            <div class="text-info">
              <span class="text-warning">Attention:</span> Viewing documentation for version
              <div class="btn-group">
                <button id="current-version" class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  3.1.0
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu" aria-labelledby="current-version">
                
                  <li class="disabled"><a href="./">3.1.0</a></li>
                
                  <li><a href="../../3.0.3/">3.0.3</a></li>
                
                  <li><a href="../../3.0.1/">3.0.1</a></li>
                
                  <li><a href="../../3.0.0/">3.0.0</a></li>
                
                  <li><a href="../../2.1.10.1/">2.1.10.1</a></li>
                
                  <li><a href="../../2.1.10/">2.1.10</a></li>
                
                  <li><a href="../../2.1.9/">2.1.9</a></li>
                
                  <li><a href="../../2.1.8/">2.1.8</a></li>
                
                  <li><a href="../../2.1.7/">2.1.7</a></li>
                
                  <li><a href="../../2.0.12.3/">2.0.12.3</a></li>
                
                </ul>
              </div>
            </div>
            
          </div>
          <div class="col-md-4">
            <form id="search" class="form-search dropdown visible-lg-inline-block" ng-controller="search" ng-class="{open: hasResults}" role="search" ng-submit="submit()" data-spy="affix" data-offset-top="130">
              <div class="form-group has-feedback">
                <input type="search" class="form-control input-sm mousetrap" placeholder="Search..." ng-model="q" ng-change="search('3.1.0')" ng-disabled="!searchReady" disabled data-hotkey="{down: moveDown, up: moveUp, esc: reset}" data-search>
              </div>
              <ul class="dropdown-menu search-results" role="menu">
                <li ng-repeat="result in results" ng-class="{'bg-warning': $index == current}"><a ng-href="{{basePath}}{{result.path}}"><span ng-bind-html="summary(result)"></span></a></li>
              </ul>
            </form>
            <a href="http://www.datastax.com/download" class="btn btn-primary btn-sm">Download</a>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid" id="content">
      <div class="row">
        <div class="col-md-3">
          <div id="navigation" class="side-nav" role="tablist" aria-multiselectable="true">
            <h3><a href="../../">Contents</a></h3>
            <ul class="nav nav-pills nav-stacked">
  
  
  <li>
    <a href="../../changelog/">
      Changelog <small>page</small>
      
    </a>
    
  </li>
  
  
  <li class="active">
    <a href="../">
      Frequently Asked Questions <small>page</small>
      
      
      <span class="glyphicon glyphicon-minus-sign pull-right" aria-hidden="true"></span>
      
      
    </a>
    <ul class="nav nav-pills nav-stacked">
  
  
  <li class="active">
    <a href="./" class="current">
      Frequently Asked Questions - OSGi <small>page</small>
      
    </a>
    <ul class="nav nav-pills nav-stacked">
  
</ul>

  </li>
  
</ul>

  </li>
  
  
  <li>
    <a href="../../manual/">
      Manual <small>page</small>
      
      
      <span class="glyphicon glyphicon-plus-sign pull-right" aria-hidden="true"></span>
      
      
    </a>
    
  </li>
  
  
  <li>
    <a href="../../upgrade_guide/">
      Upgrade guide <small>page</small>
      
    </a>
    
  </li>
  
</ul>

          </div>
        </div>
        <div class="col-md-9 content">
          <div class="crumbs-wrapper">
            <nav id="crumbs" data-spy="affix" data-offset-top="130">
              <ol class="breadcrumb">
                
                
                
                <li><a href="../../">Home</a></li>
                
                
                
                
                
                <li><a href="../">Frequently Asked Questions</a></li>
                
                
                
                
                
                <li class="active">Frequently Asked Questions - OSGi</li>
                
                
                
              </ol>
            </nav>
          </div>
          

<h2 id="frequently-asked-questions-os-gi" class="target">Frequently Asked Questions - OSGi<a class="anchor" href="#frequently-asked-questions-os-gi" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h2>

<h3 id="how-to-use-the-java-driver-in-an-os-gi-environment" class="target">How to use the Java driver in an OSGi environment?<a class="anchor" href="#how-to-use-the-java-driver-in-an-os-gi-environment" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>We have complete examples demonstrating usage of the driver in an <a href="https://www.osgi.org">OSGi</a>
environment; please refer to our <a href="https://github.com/datastax/java-driver-examples-osgi">OSGi examples repository</a>.</p>

<h3 id="how-to-override-guava-s-version" class="target">How to override Guava’s version?<a class="anchor" href="#how-to-override-guava-s-version" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The driver is compatible and tested with all versions of Guava in the range
<code>[16.0.1,20)</code>.</p>

<p>If using Maven, you can force a more specific version by re-declaring
the Guava dependency in your project, e.g.:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.google.guava&lt;/groupId&gt;
    &lt;artifactId&gt;guava&lt;/artifactId&gt;
    &lt;version&gt;19.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>Make sure that your project’s manifest is importing the right version
of Guava’s packages, e.g. for 19.0:</p>
<pre><code>Import-Package: com.google.common.base;version="[19.0,20)"
</code></pre>
<h3 id="how-to-enable-compression" class="target">How to enable compression?<a class="anchor" href="#how-to-enable-compression" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>First, read our <a href="../../manual/compression/">manual page on compression</a>
to understand how to enable compression for the Java driver.</p>

<p>OSGi projects can use both Snappy or LZ4 compression algorithms. </p>

<p>For Snappy, include the following Maven dependency:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.xerial.snappy&lt;/groupId&gt;
    &lt;artifactId&gt;snappy-java&lt;/artifactId&gt;
    &lt;version&gt;1.1.2.6&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>For LZ4, include the following Maven dependency:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;net.jpountz.lz4&lt;/groupId&gt;
    &lt;artifactId&gt;lz4&lt;/artifactId&gt;
    &lt;version&gt;1.3.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p><strong>IMPORTANT</strong>: versions of LZ4 library below 1.3.0 cannot be used
because they are <u>not</u> valid OSGi bundles.</p>

<p>Because compression libraries are <u>optional runtime dependencies</u>, 
most manifest generation tools (such as <a href="http://www.aqute.biz/Bnd">BND</a> and the <a href="https://cwiki.apache.org/confluence/display/FELIX/Apache+Felix+Maven+Bundle+Plugin+%28BND%29">Maven bundle plugin</a>) 
will not reference these libraries in your project’s manifest.
This is correct, but could be a problem for some OSGi provisioning tools,
and notably for <a href="https://eclipse.org/tycho/">Tycho</a>, because it does not consider such
dependencies when computing the target platform.</p>

<p>If you are facing provisioning issues related to compression libraries,
you might need to either add them explicitly to your OSGi runtime,
or explicitly reference them in your project’s manifest.
With the <a href="https://cwiki.apache.org/confluence/display/FELIX/Apache+Felix+Maven+Bundle+Plugin+%28BND%29">Maven bundle plugin</a>, this second option can be achieved with the following 
<a href="http://www.aqute.biz/Bnd">BND</a> <code>Import-Package</code> instruction (the example below is for
LZ4, but the same applies to Snappy as well):</p>
<pre><code>&lt;Import-Package&gt;net.jpountz.lz4,*&lt;/Import-Package&gt;
</code></pre>
<p>With Tycho, another option is to explicitly declare an “extra requirement”
to the compression library in the target platform definition:</p>
<pre><code>&lt;plugin&gt;
    &lt;groupId&gt;org.eclipse.tycho&lt;/groupId&gt;
    &lt;artifactId&gt;target-platform-configuration&lt;/artifactId&gt;
    &lt;version&gt;0.25.0&lt;/version&gt;
    &lt;configuration&gt;
        &lt;dependency-resolution&gt;
            &lt;extraRequirements&gt;
                &lt;requirement&gt;
                    &lt;id&gt;lz4-java&lt;/id&gt;
                    &lt;versionRange&gt;1.3.0&lt;/versionRange&gt;
                    &lt;type&gt;eclipse-plugin&lt;/type&gt;
                &lt;/requirement&gt;
            &lt;/extraRequirements&gt;
        &lt;/dependency-resolution&gt;
        ...
    &lt;/configuration&gt;
&lt;/plugin&gt;
</code></pre>
<p>Note that the requirement id is its bundle symbolic name,
<u>not</u> its Maven artifact id.</p>

<h3 id="how-to-use-the-driver-shaded-jar" class="target">How to use the driver shaded jar?<a class="anchor" href="#how-to-use-the-driver-shaded-jar" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The driver <a href="../../manual/shaded_jar/">shaded jar</a> can be used 
in any OSGi application, although the same limitations explained in
the manual apply.</p>

<h3 id="how-to-get-proper-logs" class="target">How to get proper logs?<a class="anchor" href="#how-to-get-proper-logs" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The driver uses <a href="http://www.slf4j.org/">SLF4j</a> for <a href="../../manual/logging/">logging</a>.</p>

<p>You OSGi runtime should therefore include the SLF4J API bundle, and
one valid implementation bundle, such as <a href="http://logback.qos.ch/">Logback</a>.</p>

<p>For Maven-based projects, this can be achieved with the following 
dependencies:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
    &lt;version&gt;1.7.12&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
    &lt;version&gt;1.1.2&lt;/version&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>
<p>Some OSGi containers might require additional configuration.
Please consult their documentation for further details.</p>

<h3 id="i-m-getting-the-error-unable-to-access-sun-misc-unsafe" class="target">I’m getting the error: “Unable to access <code>sun.misc.Unsafe</code>”<a class="anchor" href="#i-m-getting-the-error-unable-to-access-sun-misc-unsafe" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>Some of the driver dependencies try to access non-API packages
such as <code>sun.misc</code>, which is usually not available in an OSGi container.</p>

<p>Most of these libraries are smart enough to check if this package
is available or not before actually trying to use it.</p>

<p>However, the <a href="../../manual/metrics/">metrics library</a> used by the driver
attempts to load <code>sun.misc.Unsafe</code> without
probing for it first, which may lead to bundle activation errors.</p>

<p><a href="https://datastax-oss.atlassian.net/browse/JAVA-1203">JAVA-1203</a> has been created to track this issue, which
should be fixed in the next major release of the library.</p>

<p>There are a few workarounds:</p>

<ul>
<li>
<p>Add <code>sun.misc</code> to the list of system packages (i.e., packages
exported by the system bundle), or to the list of boot delegation
packages (i.e., defer loading of <code>sun.misc</code> to the boot classloader).
This is the best option as it benefits to other libraries as well.
With Felix, this can be achieved with one of the following start options:</p>
<pre><code>--bootDelegation=sun.misc
--systemPackages=sun.misc
</code></pre>
</li>
<li>
<p>Disable metrics altogether:</p>
<pre class="highlight"><code><span class="n">Cluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addContactPoints</span><span class="o">(...)</span>
        <span class="o">.</span><span class="na">withoutMetrics</span><span class="o">()</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre>
</li>
</ul>

<h3 id="i-m-getting-the-error-could-not-load-jnr-c-library" class="target">I’m getting the error: “Could not load JNR C Library”<a class="anchor" href="#i-m-getting-the-error-could-not-load-jnr-c-library" aria-hidden="true"><span class="glyphicon glyphicon-link"></span></a>
</h3>

<p>The driver is able to perform native system calls through JNR in some cases,
for example to achieve microsecond resolution when 
<a href="../../manual/query_timestamps/">generating timestamps</a>.</p>

<p>Unfortunately, some of the JNR artifacts available from Maven 
are not valid OSGi bundles and cannot be used in OSGi applications.</p>

<p><a href="https://datastax-oss.atlassian.net/browse/JAVA-1127">JAVA-1127</a> has been created to track this issue, and there
is currently no simple workaround.</p>

<p>Note that if you use Maven and include any JNR dependency
in your pom, <u>these will be silently ignored by Pax Exam when
running integration tests</u>, and most likely, your tests will
fail with provisioning errors.</p>

<p>Because native calls are not available, 
it is also normal to see the following log lines when starting the driver:</p>
<pre><code>INFO - Could not load JNR C Library, native system calls through this library will not be available
INFO - Using java.lang.System clock to generate timestamps.
</code></pre>


        </div>
      </div>
    </div>

    
    <footer class="container text-muted">
      <ul class="list-inline">
      
        
        <li>
          <a href="https://github.com/datastax/java-driver/">Code</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="http://datastax.github.io/java-driver/">Docs</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://datastax-oss.atlassian.net/browse/JAVA/">Issues</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://groups.google.com/a/lists.datastax.com/forum/#!forum/java-driver-user">Mailing List</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="irc://irc.freenode.net/datastax-drivers">IRC Channel</a>
        </li>
      
        <li>·</li>
        <li>
          <a href="https://github.com/datastax/java-driver/releases">Releases</a>
        </li>
      
      </ul>
    </footer>
    

    <script src="../../js/jquery.js"></script>
    <script src="../../js/bootstrap.js"></script>
    <script src="../../js/angular.js"></script>
    <script src="../../js/mousetrap.js"></script>
    <script src="../../js/hotkeys.js"></script>
    <script src="../../js/ZeroClipboard.js"></script>
    <script src="../../js/lunr.js"></script>
    <script src="../../js/app.js"></script>
  </body>
</html>
